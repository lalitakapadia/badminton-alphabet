-- Create users table
CREATE TABLE IF NOT EXISTS users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  supabase_uid UUID UNIQUE,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password TEXT,
  role TEXT DEFAULT 'player', -- admin, coach, player
  status TEXT DEFAULT 'pending', -- pending, approved, rejected
  club_name TEXT,
  program_name TEXT,
  coach_id BIGINT REFERENCES users(id),
  current_stage_id INTEGER DEFAULT 1,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create invitations table
CREATE TABLE IF NOT EXISTS invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT NOT NULL,
  coach_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
  token TEXT UNIQUE NOT NULL,
  status TEXT DEFAULT 'pending', -- pending, accepted, expired
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create stages table
CREATE TABLE IF NOT EXISTS stages (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create skills table
CREATE TABLE IF NOT EXISTS skills (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  level_1 TEXT,
  level_2 TEXT,
  level_3 TEXT,
  level_4 TEXT,
  level_5 TEXT,
  safety_risks TEXT,
  safety_prevention TEXT,
  safety_monitor TEXT,
  safety_stop TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create stage_skills junction table
CREATE TABLE IF NOT EXISTS stage_skills (
  stage_id BIGINT REFERENCES stages(id) ON DELETE CASCADE,
  skill_id BIGINT REFERENCES skills(id) ON DELETE CASCADE,
  PRIMARY KEY (stage_id, skill_id)
);

-- Create user_progress table
CREATE TABLE IF NOT EXISTS user_progress (
  user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
  skill_id BIGINT REFERENCES skills(id) ON DELETE CASCADE,
  status TEXT DEFAULT 'not_started',
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, skill_id)
);

-- Enable Row Level Security (RLS)
-- For this app, we'll start with simple policies or handle security via service role in server.ts
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE stages ENABLE ROW LEVEL SECURITY;
ALTER TABLE skills ENABLE ROW LEVEL SECURITY;
ALTER TABLE stage_skills ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE invitations ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Allow all for users" ON users FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all for stages" ON stages FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all for skills" ON skills FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all for stage_skills" ON stage_skills FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all for user_progress" ON user_progress FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all for invitations" ON invitations FOR ALL USING (true) WITH CHECK (true);

-- Seed initial data
INSERT INTO stages (id, name, description) VALUES 
(1, 'Stage 1: Foundation', 'Core athletic base and essential movement patterns.'),
(2, 'Stage 2: Fundamentals', 'Developing rally flow and basic hitting mechanics.'),
(3, 'Stage 3: Mechanics', 'Focusing on kinetic efficiency and offensive structure.'),
(4, 'Stage 4: Tactics & Mastery', 'Strategic positioning, speed, and high-performance variation.')
ON CONFLICT (id) DO NOTHING;

INSERT INTO skills (id, name, level_1, level_2, level_3, level_4, level_5, safety_risks, safety_prevention, safety_monitor, safety_stop) VALUES 
(1, 'A: Athletic Base', 'Static ready only', 'Split visible but late', 'Timed split in drills', 'Timed split in rally', 'Anticipatory split', 'Ankle inversion, Achilles strain', 'Soft split (land on balls of feet), Knees slightly flexed, Avoid straight-leg landing', 'Loud heel slamming, Knees collapsing inward', 'Player reports ankle tightness'),
(2, 'B: Balance', 'Falls/wobbles', 'Holds briefly', 'Stable lunge + push back', 'Stable under speed', 'Stable under pressure', 'Knee valgus (ACL risk), Patellar tendon irritation', 'Knee tracks over 2nd toe, Heel lands first, No twisting under load', 'Knee moving inward, Shaking during hold', 'Front knee pain'),
(3, 'C: Clean Contact', 'Frequent mishits', '5/10 clean stationary', '8/10 clean in movement', 'Clean under pace', 'Clean under pressure', 'Shoulder impingement, Elbow tendon strain', 'Full shoulder warm-up, Avoid repeated max power, Proper follow-through', 'Pain during backswing, Elbow rubbing', 'Sharp shoulder pain'),
(4, 'D: Direction', 'Random', 'Straight control', 'Straight + cross control', 'Intentional placement', 'Disguised direction', 'Ankle sprain during pivot, Knee torsion', 'Turn hips first, then shoulders, Avoid twisting on planted foot', 'Sudden stops on locked knee', ''),
(5, 'E: Efficient Footwork', 'Late to shuttle', 'Covers 4 corners', 'Covers 6 corners smooth', '6 corners at speed', 'Efficient + anticipatory', 'Fatigue-related form collapse, Shin splints', 'Quality over speed, Limit high-speed repeats, Ensure proper shoes', 'Heavy stomping, Sluggish recovery', ''),
(6, 'F: Flow', '3–5 shots', '6–8 shots', '10–15 shots', '20+ under pace', '30+ match intensity', 'Overexertion, Dehydration', '30–60 second rest intervals, Hydration breaks', 'Pale face, Dizziness', ''),
(7, 'G: Grip System', 'Incorrect grip', 'Correct FH grip', 'Auto FH/BH switch', 'Finger acceleration', 'Disguised grip use', 'Wrist overuse', 'Relaxed grip pressure, Avoid constant squeezing', '', ''),
(8, 'H: Height Control', 'Flat/short clears', 'Mid-court clear', 'Full backcourt clear', 'Adjusts trajectory', 'Controls tempo', 'Shoulder overload', 'Rotate drills, No more than 30 clears per set', '', ''),
(9, 'I: Impact Timing', 'Beside body', 'Attempts front contact', 'Consistent in front', 'Early interception', 'Peak contact mastery', 'Overreaching shoulder, Hyperextension', 'Contact slightly in front, No over-stretch lunges', '', ''),
(10, 'J: Jump Mechanics', 'Unsafe landing', 'Controlled landing', 'Basic scissor jump', 'Balanced jump smash', 'Seamless jump recovery', 'Ankle sprain, ACL strain, Patellar tendonitis', 'Teach landing first, Two-foot takeoff for beginners, Land softly, knees bent, No jump smash for underdeveloped players without strength base', 'Rule: If landing is noisy → reduce intensity.', ''),
(11, 'K: Kinetic Chain', 'Arm only', 'Shoulder rotation', 'Hip-shoulder sequence', 'Efficient transfer', 'Explosive full chain', 'Lower back strain', 'Engage core, Avoid hyper-arching spine', '', ''),
(12, 'L: Lunge Quality', 'Knee collapse', 'Stable but slow recover', 'Stable + push back', 'Explosive recovery', 'Net dominance control', 'Groin strain, Hip flexor overload', 'Gradual range increase, Avoid forced deep lunges', '', ''),
(13, 'M: Movement Reading', 'Reacts late', 'Reacts after net', 'Reads early', 'Anticipates patterns', 'Predicts intention', 'Fatigue can cause awkward landings.', '', '', ''),
(14, 'N: Net Control', 'Shuttle sits high', 'Basic tight net', 'Tight + lift option', 'Net spin control', 'Deceptive net mastery', 'Racket clashes, Finger strain', 'Safe spacing, No reckless net kills', '', ''),
(15, 'O: Offensive Structure', 'Random attack', 'Smash only', 'Clear-drop-smash idea', 'Structured build-up', 'Maintains attack', 'Too many smashes in a row', 'Limit consecutive smashes to 3, Rotate drills', '', ''),
(16, 'P: Positioning', 'Stays where landed', 'Returns slowly', 'Returns consistently', 'Adjusts base', 'Strategic positioning', 'Over-rotation, Slipping during recovery', 'Dry court, Proper footwear', '', ''),
(17, 'Q: Quickness', 'Slow first step', 'Visible effort', 'Fast first step', 'Rapid transitions', 'Elite reactive speed', 'Hamstring strain', 'Progressive speed build-up, No sudden max sprint cold', '', ''),
(18, 'R: Recovery', 'Walks back', 'Late recovery', 'Recovers before hit', 'Recovers ready', 'Offensive recovery', 'Fatigue collapse posture', 'Stop before form deteriorates', '', ''),
(19, 'S: Serve & Return', 'Illegal/inconsistent', 'Legal high serve', 'Accurate high/short', 'Tactical placement', 'Controls first 3 shots', 'Elbow tendonitis (overuse)', 'Limit repetitive serves, Alternate tasks', '', ''),
(20, 'T: Tactics', 'Random play', 'Sees open space', 'Uses patterns', 'Exploits weakness', 'Adapts mid-match', 'Low physical risk.', '', 'Monitor emotional stress.', ''),
(21, 'U: Under Pressure', 'Technique collapses', 'Slight instability', 'Maintains form', 'Controls rally emotions', 'Clutch performance', 'Over-breathing / dizziness', 'Teach reset breathing: Inhale 4 sec, Exhale 6 sec', '', ''),
(22, 'V: Variation', 'One pace only', 'Clear vs drop', 'Pace + angle variation', 'Multi-option attack', 'Full deception', 'Excessive slicing → wrist strain', 'Limit slice volume', '', ''),
(23, 'W: Wrist/Fingers', 'Arm dominant', 'Basic finger use', 'Drive acceleration', 'Explosive wrist', 'Micro precision control', 'Tendon overuse', 'Light resistance only, No weighted rackets for kids', '', ''),
(24, 'X: X-Factor', 'Follows only', 'Attempts creativity', 'Shows style', 'Adaptive creativity', 'Signature weapon', 'Attempting unsafe trick shots', 'No behind-the-back near net, No diving on hard floors', '', ''),
(25, 'Y: Physical Conditioning', 'Fatigues quickly', 'Moderate endurance', 'Sustains rally', 'Strong speed endurance', 'High-performance fitness', 'Overtraining', 'No more than 15 min conditioning block, Age-appropriate load', '', ''),
(26, 'Z: Zone (Mental)', 'Easily distracted', 'Short focus', 'Focus full rally', 'Resets after errors', 'Competitive composur', 'Performance anxiety', 'Normalize mistakes, Praise effort, not outcome', '', '')
ON CONFLICT (id) DO NOTHING;

-- Stage Skills Mapping
INSERT INTO stage_skills (stage_id, skill_id) VALUES 
(1, 1), (1, 2), (1, 3), (1, 5), (1, 12), (1, 18),
(2, 1), (2, 2), (2, 3), (2, 4), (2, 5), (2, 6), (2, 7), (2, 8), (2, 9), (2, 10), (2, 11), (2, 12), (2, 13), (2, 14), (2, 15), (2, 16),
(3, 1), (3, 2), (3, 3), (3, 4), (3, 5), (3, 6), (3, 7), (3, 8), (3, 9), (3, 10), (3, 11), (3, 12), (3, 13), (3, 14), (3, 15), (3, 16), (3, 17), (3, 18), (3, 19), (3, 20), (3, 21), (3, 22),
(4, 1), (4, 2), (4, 3), (4, 4), (4, 5), (4, 6), (4, 7), (4, 8), (4, 9), (4, 10), (4, 11), (4, 12), (4, 13), (4, 14), (4, 15), (4, 16), (4, 17), (4, 18), (4, 19), (4, 20), (4, 21), (4, 22), (4, 23), (4, 24), (4, 25), (4, 26)
ON CONFLICT DO NOTHING;

-- Seed initial users
INSERT INTO users (name, email, password, role, status) VALUES 
('Admin Coach', 'admin@badminton.com', 'admin123', 'admin', 'approved')
ON CONFLICT (email) DO NOTHING;

INSERT INTO users (name, email, password, role, status, current_stage_id) VALUES 
('P M', 'p.m@badminton.com', 'student123', 'player', 'approved', 1),
('S K', 's.k@badminton.com', 'student123', 'player', 'approved', 1),
('A S', 'a.s@badminton.com', 'student123', 'player', 'approved', 1),
('R R', 'r.r@badminton.com', 'student123', 'player', 'approved', 1),
('A B', 'a.b@badminton.com', 'student123', 'player', 'approved', 1),
('A S 2', 'a.s2@badminton.com', 'student123', 'player', 'approved', 1)
ON CONFLICT (email) DO NOTHING;
